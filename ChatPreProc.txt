Option Explicit

Script("Name") = "Chat Event Pre-Processor"
Script("Author") = "Pyro"
Script("Major") = 0
Script("Minor") = 3
Script("Description") = "Provides a mechanism for chat events to be dispatched to scripts prior to internal processing."

' This script allows other scripts to get advanced notice of chat events and VETO them if needed,
'   without having to manually decode the event packets in each script.
'
' Scripts wanting to use this script only need to observe it and then implement a method "Event_ChatEventReceived" with
'   the following args: EventID, Flags, Ping, IP, Account, RegAuth, Username, Message


Sub Event_PacketReceived(Protocol, ID, Length, Data)    
    ' We are only interested in BNCS packet 0x0F (SID_CHATEVENT)
    If Protocol <> "BNCS" Or ID <> &HF Then Exit Sub
    
    Dim Buffer, EventID, Flags, Ping, IP, Account, RegAuth, Username, Message
    Set Buffer = DataBufferEx()
    Buffer.Data = Data
    Buffer.GetDWord     ' Packet header
    
    EventID = Buffer.GetDWord()    
    Flags = Buffer.GetDWord()
    Ping = Buffer.GetDWord()
    IP = Buffer.GetDWord()
    Account = Buffer.GetDWord()
    RegAuth = Buffer.GetDWord()
    Username = Buffer.GetString()
    Message = Buffer.GetString()
    
    Dim Observer
    For Each Observer In GetObservers()
        Call Scripts(Observer).Event_ChatEventReceived(EventID, Flags, Ping, IP, Account, RegAuth, Username, Message)
    Next
End Sub

